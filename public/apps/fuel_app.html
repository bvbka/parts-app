<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <script src="../js/check_session.js"></script>
    <script src="../js/popUp.js"></script>

    <script src="../js/fuel/fetchRefuelings.js"></script>
    <script src="../js/fuel/generateFuelConsumptionRecords.js"></script>
    <script src="../js/fuel/generateFuelConsumptionChart.js"></script>
    <script src="../js/fuel/fetchDriverRefuelings.js"></script>
    <script src="../js/fuel/generateDriverFuelConsumptionChart.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

    <link rel="stylesheet" href="../css/global.css" />
    <link rel="stylesheet" href="../css/statsWidgets.css" />
    <link rel="stylesheet" href="../css/creatingForm.css" />
    <link rel="stylesheet" href="../css/bottomNavBar.css" />
    <link rel="stylesheet" href="../css/appTitleBar.css" />
    <link rel="stylesheet" href="../css/appBoxList.css" />
    
    <title>DEV TEST</title>
</head>

<body>
    <div class="main-options-panel">
        <div class="endpoint-option">
            <div class="app-title-bar">
                <div class="app-title-bar-description">
                    <span>Zatankuj</span>
                    <span>Dodaj nowe tankowanie</span>
                </div>
            </div>
            <div class="appContainer">
                <form id="refuelForm" class="create-form" method="post">
                    <span>Samochód</span>
                    <select name="registration" id="carSelect" required>
                        <option>Wybierz pojazd</option>
                    </select>

                    <span>Litry przed tankowaniem</span>
                    <input type="number" name="liters_before" class="liters-before-input" required disabled />
                    <div class="form-manual-instert">
                        <input type="checkbox" class="liters-before-manual-checkbox" />Wprowadź ręcznie
                    </div>

                    <span>Litry po tankowaniu</span>
                    <input type="number" name="liters_after" required />

                    <span>Przebieg</span>
                    <input type="number" name="car_mileage" class="car-mileage-input" required disabled />
                    <div class="form-manual-instert">
                        <input type="checkbox" class="car-mileage-manual-checkbox" />Wprowadź ręcznie
                    </div>

                    <input type="submit" class="primary-btn" value="Wyślij" />
                </form>

                <script>

                    const select = document.getElementById("carSelect");

                    async function getLitersSuggestion() {
                        try {
                            const response = await fetch("php/fuel/getLitersSuggestion.php");
                            if (!response.ok) throw new Error("Błąd sieci");

                            const litersSuggestion = await response.text();
                            document.querySelector(".liters-before-input").value = parseFloat(litersSuggestion);

                            const manualLitersInputCheckbox = document.querySelector(".liters-before-manual-checkbox");
                            const manualLitersInput = document.querySelector(".liters-before-input");
                            manualLitersInputCheckbox.addEventListener("change", function () {
                                manualLitersInput.disabled = !manualLitersInputCheckbox.checked;
                                if (!manualLitersInputCheckbox.checked) manualLitersInput.value = litersSuggestion;
                                else manualLitersInput.value = "";
                            });
                        } catch (error) {
                            console.error("Błąd pobierania danych:", error);
                        }
                    }
                    getLitersSuggestion();

                    var mileageSuggestion = "";
                    async function getMileageSuggestion(registation_name) {
                        try {
                            const formData = new FormData();
                            formData.append("registration", registation_name);

                            const response = await fetch("php/fuel/getMileageSuggestion.php", {
                                method: "POST",
                                body: formData
                            });
                            if (!response.ok) throw new Error("Błąd sieci");

                            mileageSuggestion = await response.text();
                            const manualMileageInputCheckbox = document.querySelector(".car-mileage-manual-checkbox");
                            const manualMileageInput = document.querySelector(".car-mileage-input");
                            manualMileageInputCheckbox.addEventListener("change", function () {
                                manualMileageInput.disabled = !manualMileageInputCheckbox.checked;
                                if (!manualMileageInputCheckbox.checked && mileageSuggestion != 0) manualMileageInput.value = mileageSuggestion;
                                else manualMileageInput.value = "";
                            });
                            if (mileageSuggestion != 0 && mileageSuggestion != "") {
                                document.querySelector(".car-mileage-input").value = parseFloat(mileageSuggestion);
                            } else {
                                document.querySelector(".car-mileage-input").value = "";
                            }
                        } catch (error) {
                            console.error("Błąd pobierania danych:", error);
                        }
                    }
                    var carSelect = document.getElementById("carSelect");
                    carSelect.addEventListener("change", function () {
                        if (carSelect.value != "Wybierz pojazd") {
                            getMileageSuggestion(carSelect.value);
                        } else {
                            mileageSuggestion = "";
                            document.querySelector(".car-mileage-input").value = "";
                        }
                    });

                    async function getCarHistory() {
                        try {
                            const response = await fetch("php/fuel/getCarHistory.php");
                            if (!response.ok) throw new Error("Błąd sieci");

                            const history = await response.json();
                        } catch (error) {
                            console.error("Błąd pobierania danych:", error);
                        }
                    }
                    getCarHistory();


                    async function getCars() {
                        try {
                            const response = await fetch("php/fuel/get-cars.php");
                            if (!response.ok) throw new Error("Błąd sieci");

                            const cars = await response.json();
                            // select.innerHTML = "";

                            if (cars.length === 0) {
                                select.innerHTML = "<option>Brak samochodów</option>";
                            } else {
                                cars.forEach(car => {
                                    const option = document.createElement("option");
                                    option.value = car.registration;
                                    option.textContent = car.registration;
                                    select.appendChild(option);
                                });
                            }
                        } catch (error) {
                            select.innerHTML = "<option>Błąd ładowania danych</option>";
                            console.error("Błąd pobierania danych:", error);
                        }
                    }
                    getCars();

                    const form = document.getElementById("refuelForm");

                    // obsługa wysyłki
                    form.addEventListener("submit", async (e) => {
                        document.querySelectorAll("input:disabled").forEach(el => el.disabled = false);
                        e.preventDefault();
                        const formData = new FormData(form);

                        try {
                            const response = await fetch("php/fuel/createRefuel.php", {
                                method: "POST",
                                body: formData
                            });

                            const result = await response.text();
                            if (result.trim() === "OK") {
                                alert("Zarejestrowano tankowanie!");
                                form.reset();
                                fetchRefuelings();
                            } else {
                                alert("Błąd: " + result);
                            }
                        } catch (error) {
                            alert("Wystąpił błąd sieci: " + error.message);
                        }
                    });
                </script>
            </div>
        </div>

        <div class="endpoint-option">
            <div class="app-title-bar">
                <div class="app-title-bar-description">
                    <span>Historia</span>
                    <span>Lista Twoich tankowań</span>
                </div>
                <div class="app-title-bar-button">

                </div>
            </div>
            <div class="appContainer">
            </div>
        </div>

        <div class="endpoint-option">
            <div class="app-title-bar">
                <div class="app-title-bar-description">
                    <span>Statystyki</span>
                    <span class="fuel-consumption-norm-span">Norma: </span>

                    <script>
                        document.querySelector(".fuel-consumption-norm-span").innerHTML += "<b class='gradient-text'>" + acceptableFuelConsumption + "l/100km</b>";
                    </script>
                </div>
                <div class="app-title-bar-button">
                    <!-- <button class="createTaskButton"><img src="img/plus.png" /></button> -->
                </div>
            </div>
            <div class="appContainer">
                <div class="widget">
                    <div class="widget-text">Rekordowe wartości</div>
                </div>
                <div class="widget quadro-data">
                    <div class="widget-quadro widget-quadro-top-left">
                        <span class="gradient-text"></span>
                        <span>l/100 km</span>
                        <span>Najniższe</span>
                    </div>
                    <div class="widget-quadro widget-quadro-top-right">
                        <span class="gradient-text"></span>
                        <span>l/100 km</span>
                        <span>Najwyższe</span>
                    </div>
                    <div class="widget-quadro widget-quadro-bottom-left">
                        <span class="gradient-text"></span>
                        <span>l/100 km</span>
                        <span>Średnie</span>
                    </div>
                    <div class="widget-quadro widget-quadro-bottom-right">
                        <span class="gradient-text"></span>
                        <span>dni</span>
                        <span>Passa</span>
                    </div>
                </div>
                <div class="widget">
                    <div class="widget-text">Spalanie w liczbach</div>
                </div>
                <div class="widget double-data">
                    <div class="widget-double-first">
                        <span></span><br>
                        <span>Tras w normie</span>
                    </div>
                    <div class="widget-double-second">
                        <span></span><br>
                        <span>Tras poza normą</span>
                    </div>
                </div>
                <div class="widget">
                    <div class="widget-text">Wykres spalania</div>
                </div>
                <div class="widget widget-line-chart">
                    <div class="widget-pie-chart-canvas">
                        <canvas id="consumptionLineChart"></canvas>
                    </div>
                </div>
            </div>
        </div>


        <div class="endpoint-option">
            <div class="app-title-bar">
                <div class="app-title-bar-description">
                    <span>Kierowcy</span>
                    <span class="fuel-consumption-norm-span">Norma: </span>

                    <script>
                        document.querySelectorAll(".fuel-consumption-norm-span")[1].innerHTML += "<b class='gradient-text'>" + acceptableFuelConsumption + "l/100km</b>";
                    </script>
                </div>
                <div class="app-title-bar-button">
                    <!-- <button class="createTaskButton"><img src="img/plus.png" /></button> -->
                </div>
            </div>
            <div class="appContainer">
                <div class="widget">
                    <div class="widget-text">Statystyki kierowcy</div>
                </div>
                <div class="widget select-widget">
                    <select class="widget-select driver-select">
                        <option value="default">Wybierz kierowcę</option>
                    </select>
                </div>
                <div class="widget widget-line-chart">
                    <div class="widget-pie-chart-canvas">
                        <canvas id="driverConsumptionLineChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <script>
            var driverListSelect = document.querySelector(".driver-select");
            async function getDriverList() {
                try {
                    const response = await fetch("php/fuel/getDriverList.php");
                    if (!response.ok) throw new Error("Błąd sieci");

                    const users = await response.json();

                    if (users.length === 0) {
                        driverListSelect.innerHTML = "<option>Brak samochodów</option>";
                    } else {
                        users.forEach(user => {
                            const option = document.createElement("option");
                            option.value = user.alias;
                            option.textContent = user.name;
                            driverListSelect.appendChild(option);
                        });
                    }
                } catch (error) {
                    driverListSelect.innerHTML = "<option>Błąd ładowania danych</option>";
                    console.error("Błąd pobierania danych:", error);
                }
            }
            getDriverList();

            driverListSelect.addEventListener("change", function () {
                if (driverListSelect.value != "default") {
                    console.log(driverListSelect.value);
                    async function generateDriverChart() {
                        const fuelData2 = await fetchDriverRefuelings(driverListSelect.value);
                        generateDriverFuelConsumptionChart(fuelData2);
                    }
                    generateDriverChart()
                }
            });
        </script>

        <div class="navigation-bar">
            <div class="selected-option-panel">
                <div class="selected-option"></div>
            </div>
            <div class="options-panel">
                <div class="panel-option">
                    ➕
                </div>
                <div class="panel-option">
                    📅
                </div>
                <div class="panel-option">
                    🚀
                </div>
                <div class="panel-option">
                    🚛
                </div>
            </div>
        </div>
    </div>

    <script>
        var optionMarker = document.querySelector(".selected-option");
        var options = document.querySelectorAll(".panel-option");
        var optionsPanel = document.querySelector(".options-panel");
        var endPoints = document.querySelectorAll(".endpoint-option");

        endPoints.forEach(end => {
            end.style.display = "none";
        });

        endPoints[0].style.display = "block";

        optionMarker.style.width = (document.body.clientWidth / options.length) + "px";

        options[0].style.color = "var(--panel-accent-color)";

        // Domyślnie ustaw gradient dla pierwszej opcji:
        if (options.length > 0) {
            options.forEach(option => {
                option.style.color = "rgba(255, 255, 255, 0.3)";
                const g = option.querySelector('g');
                if (g) g.setAttribute('fill', 'currentColor');
            });
            options[0].style.color = 'rgba(255,255,255,0.3)'; // lub inny kolor bazowy widoczny przy gradiencie
            const g0 = options[0].querySelector('g');
            if (g0) g0.setAttribute('fill', 'url(#myGradient)');
            endPoints.forEach(end => (end.style.display = 'none'));
            if (endPoints[0]) endPoints[0].style.display = 'block';
        }

        for (let i = 0; i < options.length; i++) {
            let opt = options[i];
            opt.addEventListener("click", function () {
                optionMarker.style.marginLeft = (parseFloat(optionMarker.style.width) * i) + "px";

                options.forEach(option => {
                    option.style.color = "rgba(255, 255, 255, 0.3)";
                    const g = option.querySelector('g');
                    if (g) g.setAttribute('fill', 'currentColor');
                });

                this.style.color = 'rgba(255,255,255,0.3)'; // albo inny kolor bazowy, by gradient był widoczny
                const g = this.querySelector('g');
                if (g) g.setAttribute('fill', 'url(#myGradient)');

                endPoints.forEach(end => (end.style.display = "none"));
                endPoints[i].style.display = "block";
            });
        }

        const titleBars = document.querySelectorAll('.app-title-bar');

        window.addEventListener('scroll', () => {
            if (window.scrollY > 0) {
                titleBars.forEach(bar => bar.classList.add('scrolled'));
            } else {
                titleBars.forEach(bar => bar.classList.remove('scrolled'));
            }
        });

    </script>


    <script>
        async function initFuelData() {
            const fuelData = await fetchRefuelings();
            generateFuelConsumptionChart(fuelData);
            generateFuelConsumptionRecords(fuelData);
            // const fuelData2 = await fetchDriverRefuelings();
            // console.log("fuelData2:",fuelData2);
        }

        initFuelData();
    </script>
</body>

</html>